(()=>{"use strict";const e=window.React,t=window.wc.blocksCheckout,a=window.wp.plugins,o=window.wp.element,c=window.wp.i18n,n=window.wp.data,r=window.wc.wcBlocksData,s=window.wc.wcSettings,l=window.ReactDOM,i=({iframeUrl:t,allowedOrigins:a,onSelect:c,onClose:n})=>{const r=(0,o.useCallback)(e=>{if(a.includes(e.origin)){if(e.data&&"dealerUpdate"===e.data.type){const t=e.data.value;t&&c(t)}e.data&&"closeModal"===e.data.type&&n()}},[a,c,n]),s=(0,o.useCallback)(e=>{"Escape"===e.key&&n()},[n]),i=(0,o.useCallback)(e=>{e.target===e.currentTarget&&n()},[n]);(0,o.useEffect)(()=>{window.addEventListener("message",r),document.addEventListener("keydown",s);const e=document.body.style.overflow;return document.body.style.overflow="hidden",()=>{window.removeEventListener("message",r),document.removeEventListener("keydown",s),document.body.style.overflow=e}},[r,s]);const d=(0,e.createElement)("div",{className:"automaticffl-dealer-layer visible",onClick:i,role:"dialog","aria-modal":"true","aria-label":"FFL Dealer Selection"},(0,e.createElement)("div",{className:"dealers-container"},(0,e.createElement)("iframe",{id:"automaticffl-map-iframe",src:t,title:"FFL Dealer Selection",style:{width:"100%",height:"100%",border:"none"}})));return(0,l.createPortal)(d,document.body)},d=({dealer:t,userName:a})=>{const o=[t.address1,t.city,t.stateOrProvinceCode].filter(Boolean).join(", "),n=(e=>{if(!e)return"";const t=e.replace(/\D/g,"");return 10===t.length?`(${t.slice(0,3)})-${t.slice(3,6)}-${t.slice(6)}`:e})(t.phone),r=`${a.first_name} ${a.last_name}`;return(0,e.createElement)("div",{id:"automaticffl-dealer-selected",className:"automaticffl-dealer-selected"},(0,e.createElement)("p",null,(0,c.__)("Your order will be shipped to","automaticffl-for-wc"),":"),(0,e.createElement)("div",{id:"ffl-selected-dealer",className:"ffl-result-body"},(0,e.createElement)("p",{className:"customer-name"},r),(0,e.createElement)("p",{className:"dealer-name"},t.company||""),(0,e.createElement)("p",{className:"dealer-address"},o),t.phone&&(0,e.createElement)("a",{href:`tel:${t.phone}`},(0,e.createElement)("p",null,(0,e.createElement)("span",{className:"dealer-phone dealer-phone-formatted"},n)))))},m=[".wp-block-woocommerce-checkout-shipping-address-block",".wc-block-checkout__shipping-fields"],u=[".wc-block-checkout__use-address-for-billing"],f=()=>{const t=(()=>{let e=(0,s.getSetting)("automaticffl_data",null);return!e&&"undefined"!=typeof window&&window.automaticfflBlocksData&&(e=window.automaticfflBlocksData),e=e||{},{isFflCart:e.isFflCart||!1,hasFflProducts:e.hasFflProducts||!1,isMixedCart:e.isMixedCart||!1,iframeUrl:e.iframeUrl||"",allowedOrigins:e.allowedOrigins||[],userName:e.userName||{first_name:"FFL",last_name:"Dealer"},isConfigured:e.isConfigured||!1}})(),[a,l]=(0,o.useState)(!1),[f,w]=(0,o.useState)(null),[h,p]=(0,o.useState)(!1),{setShippingAddress:b}=(0,n.useDispatch)(r.CART_STORE_KEY),y=(0,o.useCallback)((e,t)=>{try{const a=wp.data.dispatch("wc/store/checkout");a&&"function"==typeof a.setExtensionData?a.setExtensionData(e,t):a&&"function"==typeof a.__internalSetExtensionData&&a.__internalSetExtensionData(e,t)}catch(e){console.error("AutomaticFFL: Could not set extension data",e)}},[]),v=(0,o.useRef)(!1),g=(0,o.useCallback)(e=>{w(e),l(!1),e&&e.fflID&&p(!1),y("automaticffl",{fflLicense:e.fflID||""}),b({first_name:t.userName.first_name,last_name:t.userName.last_name,company:e.company||"",address_1:e.address1||"",address_2:e.address2||"",city:e.city||"",state:e.stateOrProvinceCode||"",postcode:e.postalCode||"",country:e.countryCode||"US",phone:e.phone||""})},[y,b,t.userName]);return(0,o.useEffect)(()=>{const e=t.hasFflProducts&&!t.isMixedCart&&t.isConfigured,a=()=>{(()=>{for(const t of m){const a=document.querySelector(t);a&&(e?(a.style.display="none",a.setAttribute("data-ffl-hidden","true"),v.current=!0):"true"===a.getAttribute("data-ffl-hidden")&&(a.style.display="",a.removeAttribute("data-ffl-hidden"),v.current=!1))}})(),(()=>{for(const t of u){const a=document.querySelector(t);if(a)if(e){const e=a.querySelector('input[type="checkbox"]')||a;e.checked&&e.click(),a.style.display="none",a.setAttribute("data-ffl-hidden","true")}else"true"===a.getAttribute("data-ffl-hidden")&&(a.style.display="",a.removeAttribute("data-ffl-hidden"))}})()};a();const o=new MutationObserver(e=>{e.some(e=>"childList"===e.type&&e.addedNodes.length>0&&Array.from(e.addedNodes).some(e=>e.nodeType===Node.ELEMENT_NODE&&[...m,...u].some(t=>e.matches?.(t)||e.querySelector?.(t))))&&a()}),c=document.querySelector(".wc-block-checkout")||document.body;return o.observe(c,{childList:!0,subtree:!0}),e?document.body.classList.add("automaticffl-checkout-active"):document.body.classList.remove("automaticffl-checkout-active"),()=>{if(o.disconnect(),v.current){for(const e of m){const t=document.querySelector(e);t&&"true"===t.getAttribute("data-ffl-hidden")&&(t.style.display="",t.removeAttribute("data-ffl-hidden"))}for(const e of u){const t=document.querySelector(e);t&&"true"===t.getAttribute("data-ffl-hidden")&&(t.style.display="",t.removeAttribute("data-ffl-hidden"))}document.body.classList.remove("automaticffl-checkout-active")}}},[t.hasFflProducts,t.isMixedCart,t.isConfigured]),(0,o.useEffect)(()=>{if("undefined"!=typeof wp&&wp.hooks)return wp.hooks.addAction("woocommerce_blocks_checkout_after_processing_with_error","automaticffl",()=>{f||p(!0)}),()=>{"undefined"!=typeof wp&&wp.hooks&&wp.hooks.removeAction("woocommerce_blocks_checkout_after_processing_with_error","automaticffl")}},[f]),t.hasFflProducts?t.isMixedCart?(0,e.createElement)("div",{className:"wc-block-components-notices"},(0,e.createElement)("div",{className:"wc-block-components-notice-banner is-error"},(0,e.createElement)("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",width:"24",height:"24","aria-hidden":"true",focusable:"false"},(0,e.createElement)("path",{d:"M12 3.2c-4.8 0-8.8 3.9-8.8 8.8 0 4.8 3.9 8.8 8.8 8.8 4.8 0 8.8-3.9 8.8-8.8 0-4.8-4-8.8-8.8-8.8zm0 16c-4 0-7.2-3.2-7.2-7.2C4.8 8 8 4.8 12 4.8s7.2 3.2 7.2 7.2c0 4-3.2 7.2-7.2 7.2zM11 8h2v5h-2V8zm0 6h2v2h-2v-2z"})),(0,e.createElement)("div",{className:"wc-block-components-notice-banner__content"},(0,c.__)("Your cart contains both firearms and non-firearm items. Please purchase them separately.","automaticffl-for-wc")))):t.isConfigured?(0,e.createElement)("div",{className:"automaticffl-dealer-selection"},(0,e.createElement)("div",{className:"wc-block-components-notices"},(0,e.createElement)("div",{className:"wc-block-components-notice-banner is-info"},(0,e.createElement)("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",width:"24",height:"24","aria-hidden":"true",focusable:"false"},(0,e.createElement)("path",{d:"M12 3.2c-4.8 0-8.8 3.9-8.8 8.8 0 4.8 3.9 8.8 8.8 8.8 4.8 0 8.8-3.9 8.8-8.8 0-4.8-4-8.8-8.8-8.8zm0 16c-4 0-7.2-3.2-7.2-7.2C4.8 8 8 4.8 12 4.8s7.2 3.2 7.2 7.2c0 4-3.2 7.2-7.2 7.2zM11 8h2v6h-2V8zm0 8h2v2h-2v-2z"})),(0,e.createElement)("div",{className:"wc-block-components-notice-banner__content"},(0,c.__)("You have a firearm in your cart and must choose a Licensed Firearm Dealer (FFL) for the Shipping Address.","automaticffl-for-wc")))),h&&!f&&(0,e.createElement)("div",{className:"wc-block-components-notices"},(0,e.createElement)("div",{className:"wc-block-components-notice-banner is-error"},(0,e.createElement)("div",{className:"wc-block-components-notice-banner__content"},(0,c.__)("Please select an FFL dealer before placing your order.","automaticffl-for-wc")))),f&&(0,e.createElement)(d,{dealer:f,userName:t.userName}),(0,e.createElement)("button",{type:"button",className:"wc-block-components-button wp-element-button ffl-search-button",onClick:()=>l(!0)},(0,e.createElement)("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 512 512",width:"16",height:"16",fill:"currentColor","aria-hidden":"true",style:{verticalAlign:"middle",marginRight:"8px"}},(0,e.createElement)("path",{d:"M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM208 352a144 144 0 1 0 0-288 144 144 0 1 0 0 288z"})),f?(0,c.__)("Change Dealer","automaticffl-for-wc"):(0,c.__)("Find a Dealer","automaticffl-for-wc")),a&&(0,e.createElement)(i,{iframeUrl:t.iframeUrl,allowedOrigins:t.allowedOrigins,onSelect:g,onClose:()=>l(!1)})):(0,e.createElement)("div",{className:"wc-block-components-notices"},(0,e.createElement)("div",{className:"wc-block-components-notice-banner is-error"},(0,e.createElement)("div",{className:"wc-block-components-notice-banner__content"},(0,c.__)("FFL dealer selection is not configured. Please contact the site administrator.","automaticffl-for-wc")))):null};(0,a.registerPlugin)("automaticffl-dealer-selection",{render:()=>(0,e.createElement)(t.ExperimentalOrderShippingPackages,null,(0,e.createElement)(f,null)),scope:"woocommerce-checkout"})})();